{"version":3,"sources":["../../../src/build/flying-shuttle/store-shuttle.ts"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\nimport { execSync } from 'child_process'\nimport { recursiveCopy } from '../../lib/recursive-copy'\nimport { version as nextVersion } from 'next/package.json'\nimport type { NextConfigComplete } from '../../server/config-shared'\nimport {\n  BUILD_MANIFEST,\n  APP_BUILD_MANIFEST,\n  REACT_LOADABLE_MANIFEST,\n  APP_PATH_ROUTES_MANIFEST,\n  PAGES_MANIFEST,\n  ROUTES_MANIFEST,\n} from '../../shared/lib/constants'\n\nexport interface ShuttleManifest {\n  nextVersion: string\n  config: Record<string, any>\n  gitSha?: string\n}\n\nexport function generateShuttleManifest(config: NextConfigComplete) {\n  let gitSha = ''\n\n  try {\n    gitSha = execSync('git rev-parse HEAD').toString().trim()\n  } catch (_) {}\n\n  return JSON.stringify({\n    gitSha,\n    nextVersion,\n    config: {\n      i18n: config.i18n,\n      basePath: config.basePath,\n      sassOptions: config.sassOptions,\n      trailingSlash: config.trailingSlash,\n\n      experimental: {\n        ppr: config.experimental.ppr,\n        reactCompiler: config.experimental.reactCompiler,\n      },\n    },\n  } satisfies ShuttleManifest)\n}\n\n// we can create a new shuttle with the outputs before env values have\n// been inlined, can be done after stitching takes place\nexport async function storeShuttle({\n  config,\n  distDir,\n  shuttleDir,\n}: {\n  distDir: string\n  shuttleDir: string\n  config: NextConfigComplete\n}) {\n  await fs.promises.rm(shuttleDir, { force: true, recursive: true })\n  await fs.promises.mkdir(shuttleDir, { recursive: true })\n\n  await fs.promises.writeFile(\n    path.join(shuttleDir, 'shuttle-manifest.json'),\n    generateShuttleManifest(config)\n  )\n\n  // copy all server entries\n  await recursiveCopy(\n    path.join(distDir, 'server'),\n    path.join(shuttleDir, 'server'),\n    {\n      filter(item) {\n        return !item.match(/\\.(rsc|meta|html)$/)\n      },\n    }\n  )\n\n  const pagesManifest = JSON.parse(\n    await fs.promises.readFile(\n      path.join(shuttleDir, 'server', PAGES_MANIFEST),\n      'utf8'\n    )\n  )\n  // ensure manifest isn't modified to .html as it's before static gen\n  for (const key of Object.keys(pagesManifest)) {\n    pagesManifest[key] = pagesManifest[key].replace(/\\.html$/, '.js')\n  }\n  await fs.promises.writeFile(\n    path.join(shuttleDir, 'server', PAGES_MANIFEST),\n    JSON.stringify(pagesManifest)\n  )\n\n  // copy static assets\n  await recursiveCopy(\n    path.join(distDir, 'static'),\n    path.join(shuttleDir, 'static')\n  )\n\n  // copy manifests not nested in {distDir}/server/\n  await fs.promises.mkdir(path.join(shuttleDir, 'manifests'), {\n    recursive: true,\n  })\n\n  for (const item of [\n    BUILD_MANIFEST,\n    ROUTES_MANIFEST,\n    APP_BUILD_MANIFEST,\n    REACT_LOADABLE_MANIFEST,\n    APP_PATH_ROUTES_MANIFEST,\n  ]) {\n    const outputPath = path.join(shuttleDir, 'manifests', item)\n    await fs.promises.mkdir(path.dirname(outputPath), { recursive: true })\n    await fs.promises.copyFile(path.join(distDir, item), outputPath)\n  }\n}\n"],"names":["generateShuttleManifest","storeShuttle","config","gitSha","execSync","toString","trim","_","JSON","stringify","nextVersion","i18n","basePath","sassOptions","trailingSlash","experimental","ppr","reactCompiler","distDir","shuttleDir","fs","promises","rm","force","recursive","mkdir","writeFile","path","join","recursiveCopy","filter","item","match","pagesManifest","parse","readFile","PAGES_MANIFEST","key","Object","keys","replace","BUILD_MANIFEST","ROUTES_MANIFEST","APP_BUILD_MANIFEST","REACT_LOADABLE_MANIFEST","APP_PATH_ROUTES_MANIFEST","outputPath","dirname","copyFile"],"mappings":";;;;;;;;;;;;;;;IAqBgBA,uBAAuB;eAAvBA;;IA0BMC,YAAY;eAAZA;;;2DA/CP;6DACE;+BACQ;+BACK;6BACS;2BAShC;;;;;;AAQA,SAASD,wBAAwBE,MAA0B;IAChE,IAAIC,SAAS;IAEb,IAAI;QACFA,SAASC,IAAAA,uBAAQ,EAAC,sBAAsBC,QAAQ,GAAGC,IAAI;IACzD,EAAE,OAAOC,GAAG,CAAC;IAEb,OAAOC,KAAKC,SAAS,CAAC;QACpBN;QACAO,aAAAA,oBAAW;QACXR,QAAQ;YACNS,MAAMT,OAAOS,IAAI;YACjBC,UAAUV,OAAOU,QAAQ;YACzBC,aAAaX,OAAOW,WAAW;YAC/BC,eAAeZ,OAAOY,aAAa;YAEnCC,cAAc;gBACZC,KAAKd,OAAOa,YAAY,CAACC,GAAG;gBAC5BC,eAAef,OAAOa,YAAY,CAACE,aAAa;YAClD;QACF;IACF;AACF;AAIO,eAAehB,aAAa,EACjCC,MAAM,EACNgB,OAAO,EACPC,UAAU,EAKX;IACC,MAAMC,WAAE,CAACC,QAAQ,CAACC,EAAE,CAACH,YAAY;QAAEI,OAAO;QAAMC,WAAW;IAAK;IAChE,MAAMJ,WAAE,CAACC,QAAQ,CAACI,KAAK,CAACN,YAAY;QAAEK,WAAW;IAAK;IAEtD,MAAMJ,WAAE,CAACC,QAAQ,CAACK,SAAS,CACzBC,aAAI,CAACC,IAAI,CAACT,YAAY,0BACtBnB,wBAAwBE;IAG1B,0BAA0B;IAC1B,MAAM2B,IAAAA,4BAAa,EACjBF,aAAI,CAACC,IAAI,CAACV,SAAS,WACnBS,aAAI,CAACC,IAAI,CAACT,YAAY,WACtB;QACEW,QAAOC,IAAI;YACT,OAAO,CAACA,KAAKC,KAAK,CAAC;QACrB;IACF;IAGF,MAAMC,gBAAgBzB,KAAK0B,KAAK,CAC9B,MAAMd,WAAE,CAACC,QAAQ,CAACc,QAAQ,CACxBR,aAAI,CAACC,IAAI,CAACT,YAAY,UAAUiB,yBAAc,GAC9C;IAGJ,oEAAoE;IACpE,KAAK,MAAMC,OAAOC,OAAOC,IAAI,CAACN,eAAgB;QAC5CA,aAAa,CAACI,IAAI,GAAGJ,aAAa,CAACI,IAAI,CAACG,OAAO,CAAC,WAAW;IAC7D;IACA,MAAMpB,WAAE,CAACC,QAAQ,CAACK,SAAS,CACzBC,aAAI,CAACC,IAAI,CAACT,YAAY,UAAUiB,yBAAc,GAC9C5B,KAAKC,SAAS,CAACwB;IAGjB,qBAAqB;IACrB,MAAMJ,IAAAA,4BAAa,EACjBF,aAAI,CAACC,IAAI,CAACV,SAAS,WACnBS,aAAI,CAACC,IAAI,CAACT,YAAY;IAGxB,iDAAiD;IACjD,MAAMC,WAAE,CAACC,QAAQ,CAACI,KAAK,CAACE,aAAI,CAACC,IAAI,CAACT,YAAY,cAAc;QAC1DK,WAAW;IACb;IAEA,KAAK,MAAMO,QAAQ;QACjBU,yBAAc;QACdC,0BAAe;QACfC,6BAAkB;QAClBC,kCAAuB;QACvBC,mCAAwB;KACzB,CAAE;QACD,MAAMC,aAAanB,aAAI,CAACC,IAAI,CAACT,YAAY,aAAaY;QACtD,MAAMX,WAAE,CAACC,QAAQ,CAACI,KAAK,CAACE,aAAI,CAACoB,OAAO,CAACD,aAAa;YAAEtB,WAAW;QAAK;QACpE,MAAMJ,WAAE,CAACC,QAAQ,CAAC2B,QAAQ,CAACrB,aAAI,CAACC,IAAI,CAACV,SAASa,OAAOe;IACvD;AACF"}