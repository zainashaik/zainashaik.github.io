{"version":3,"sources":["../../../src/build/flying-shuttle/detect-changed-entries.ts"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\nimport crypto from 'crypto'\nimport { execSync } from 'child_process'\nimport { getPageFromPath } from '../entries'\nimport originalDebug from 'next/dist/compiled/debug'\nimport { Sema } from 'next/dist/compiled/async-sema'\nimport { generateShuttleManifest, type ShuttleManifest } from './store-shuttle'\nimport type { NextConfigComplete } from '../../server/config-shared'\nimport { updateIncrementalBuildMetrics } from '../../diagnostics/build-diagnostics'\n\nconst debug = originalDebug('next:build:flying-shuttle')\n\nexport interface DetectedEntriesResult {\n  app: string[]\n  pages: string[]\n}\n\nfunction deepEqual(obj1: any, obj2: any) {\n  if (obj1 === obj2) return true\n\n  if (\n    typeof obj1 !== 'object' ||\n    obj1 === null ||\n    typeof obj2 !== 'object' ||\n    obj2 === null\n  ) {\n    return false\n  }\n\n  let keys1 = Object.keys(obj1)\n  let keys2 = Object.keys(obj2)\n\n  if (keys1.length !== keys2.length) return false\n\n  for (let key of keys1) {\n    if (!keys2.includes(key) || !deepEqual(obj1[key], obj2[key])) {\n      return false\n    }\n  }\n\n  return true\n}\n\nlet _hasShuttle: undefined | boolean = undefined\nexport async function hasShuttle(\n  config: NextConfigComplete,\n  shuttleDir: string\n) {\n  if (typeof _hasShuttle === 'boolean') {\n    return _hasShuttle\n  }\n  let foundShuttleManifest: ShuttleManifest\n\n  async function pruneCache() {\n    await fs.promises.rm(shuttleDir, { force: true, recursive: true })\n    await fs.promises.mkdir(shuttleDir, { recursive: true })\n  }\n\n  try {\n    foundShuttleManifest = JSON.parse(\n      await fs.promises.readFile(\n        path.join(shuttleDir, 'shuttle-manifest.json'),\n        'utf8'\n      )\n    )\n    _hasShuttle = true\n  } catch (err: unknown) {\n    _hasShuttle = false\n    console.log(`Failed to read shuttle manifest`)\n    // prune potentially corrupted cache\n    await pruneCache()\n    return _hasShuttle\n  }\n  const currentShuttleManifest = JSON.parse(\n    generateShuttleManifest(config)\n  ) as ShuttleManifest\n\n  if (currentShuttleManifest.nextVersion !== foundShuttleManifest.nextVersion) {\n    // we don't allow using shuttle from differing Next.js version\n    // as it could have internal changes\n    console.log(\n      `shuttle has differing Next.js version ${foundShuttleManifest.nextVersion} versus current ${currentShuttleManifest.nextVersion}, skipping.`\n    )\n    _hasShuttle = false\n  }\n\n  if (!deepEqual(currentShuttleManifest.config, foundShuttleManifest.config)) {\n    _hasShuttle = false\n    console.log(\n      `Mismatching shuttle configs`,\n      currentShuttleManifest.config,\n      foundShuttleManifest.config\n    )\n  }\n\n  if (_hasShuttle) {\n    let currentGitSha = ''\n\n    try {\n      currentGitSha = execSync('git rev-parse HEAD').toString().trim()\n    } catch (_) {}\n\n    await updateIncrementalBuildMetrics({\n      currentGitSha,\n      shuttleGitSha: currentShuttleManifest.gitSha,\n    })\n  } else {\n    // prune mis-matching cache\n    await pruneCache()\n  }\n  return _hasShuttle\n}\n\nexport async function detectChangedEntries({\n  appPaths,\n  pagesPaths,\n  pageExtensions,\n  distDir,\n  shuttleDir,\n  config,\n}: {\n  appPaths?: string[]\n  pagesPaths?: string[]\n  pageExtensions: string[]\n  distDir: string\n  shuttleDir: string\n  config: NextConfigComplete\n}): Promise<{\n  changed: DetectedEntriesResult\n  unchanged: DetectedEntriesResult\n}> {\n  const changedEntries: {\n    app: string[]\n    pages: string[]\n  } = {\n    app: [],\n    pages: [],\n  }\n  const unchangedEntries: typeof changedEntries = {\n    app: [],\n    pages: [],\n  }\n\n  if (!(await hasShuttle(config, shuttleDir))) {\n    // no shuttle so consider everything changed\n    console.log(`no shuttle. can't detect changes`)\n    return {\n      changed: {\n        pages: pagesPaths || [],\n        app: appPaths || [],\n      },\n      unchanged: {\n        pages: [],\n        app: [],\n      },\n    }\n  }\n\n  const hashCache = new Map<string, string>()\n\n  async function computeHash(p: string): Promise<string> {\n    let hash = hashCache.get(p)\n    if (hash) {\n      return hash\n    }\n    return new Promise((resolve, reject) => {\n      const hashInst = crypto.createHash('sha1')\n      const stream = fs.createReadStream(p)\n      stream.on('error', (err) => reject(err))\n      stream.on('data', (chunk) => hashInst.update(chunk))\n      stream.on('end', () => {\n        const digest = hashInst.digest('hex')\n        resolve(digest)\n        hashCache.set(p, digest)\n      })\n    })\n  }\n\n  const hashSema = new Sema(16)\n  let globalEntryChanged = false\n  const changedDependencies: Record<string, string> = {}\n\n  async function detectChange({\n    normalizedEntry,\n    entry,\n    type,\n  }: {\n    entry: string\n    normalizedEntry: string\n    type: keyof typeof changedEntries\n  }) {\n    const traceFile = path.join(\n      shuttleDir,\n      'server',\n      type,\n      `${normalizedEntry}.js.nft.json`\n    )\n    let changed = true\n\n    // we don't need to check any further entry's dependencies if\n    // a global entry changed since that invalidates everything\n    if (!globalEntryChanged) {\n      try {\n        const traceData: {\n          fileHashes: Record<string, string>\n        } = JSON.parse(await fs.promises.readFile(traceFile, 'utf8'))\n\n        if (traceData) {\n          let changedDependency = false\n          await Promise.all(\n            Object.keys(traceData.fileHashes).map(async (file) => {\n              try {\n                if (changedDependency) return\n                await hashSema.acquire()\n                const relativeTraceFile = path.relative(\n                  path.join(shuttleDir, 'server', type),\n                  traceFile\n                )\n                const originalTraceFile = path.join(\n                  distDir,\n                  'server',\n                  type,\n                  relativeTraceFile\n                )\n                const absoluteFile = path.join(\n                  path.dirname(originalTraceFile),\n                  file\n                )\n\n                if (absoluteFile.startsWith(distDir)) {\n                  return\n                }\n\n                const prevHash = traceData.fileHashes[file]\n                const curHash = await computeHash(absoluteFile)\n\n                if (prevHash !== curHash) {\n                  changedDependencies[normalizedEntry] = file\n                  debug('detected change on', {\n                    prevHash,\n                    curHash,\n                    file,\n                    entry: normalizedEntry,\n                  })\n                  changedDependency = true\n                }\n              } finally {\n                hashSema.release()\n              }\n            })\n          )\n\n          if (!changedDependency) {\n            changed = false\n          }\n        } else {\n          console.error('missing trace data', traceFile, normalizedEntry)\n        }\n      } catch (err) {\n        console.error(\n          `Failed to detect change for ${entry} ${normalizedEntry}`,\n          err\n        )\n      }\n    }\n\n    // we always rebuild global entries so we have a version\n    // that matches the newest build/runtime\n    const isGlobalEntry = /(_app|_document|_error)/.test(entry)\n\n    if (changed || isGlobalEntry) {\n      // if a global entry changed all entries are changed\n      if (changed && !globalEntryChanged && isGlobalEntry) {\n        console.log(`global entry ${entry} changed invalidating all entries`)\n        globalEntryChanged = true\n        // move unchanged to changed\n        changedEntries[type].push(...unchangedEntries[type])\n      }\n      changedEntries[type].push(entry)\n    } else {\n      unchangedEntries[type].push(entry)\n    }\n  }\n\n  // loop over entries and their dependency's hashes\n  // to detect which changed\n  for (const entry of pagesPaths || []) {\n    let normalizedEntry = getPageFromPath(entry, pageExtensions)\n\n    if (normalizedEntry === '/') {\n      normalizedEntry = '/index'\n    }\n    await detectChange({ entry, normalizedEntry, type: 'pages' })\n  }\n\n  for (const entry of appPaths || []) {\n    let normalizedEntry = getPageFromPath(entry, pageExtensions)\n\n    if (normalizedEntry === '/not-found') {\n      normalizedEntry = '/_not-found/page'\n    }\n    await detectChange({ entry, normalizedEntry, type: 'app' })\n  }\n  await updateIncrementalBuildMetrics({ changedDependencies })\n\n  return {\n    changed: changedEntries,\n    unchanged: unchangedEntries,\n  }\n}\n"],"names":["detectChangedEntries","hasShuttle","debug","originalDebug","deepEqual","obj1","obj2","keys1","Object","keys","keys2","length","key","includes","_hasShuttle","undefined","config","shuttleDir","foundShuttleManifest","pruneCache","fs","promises","rm","force","recursive","mkdir","JSON","parse","readFile","path","join","err","console","log","currentShuttleManifest","generateShuttleManifest","nextVersion","currentGitSha","execSync","toString","trim","_","updateIncrementalBuildMetrics","shuttleGitSha","gitSha","appPaths","pagesPaths","pageExtensions","distDir","changedEntries","app","pages","unchangedEntries","changed","unchanged","hashCache","Map","computeHash","p","hash","get","Promise","resolve","reject","hashInst","crypto","createHash","stream","createReadStream","on","chunk","update","digest","set","hashSema","Sema","globalEntryChanged","changedDependencies","detectChange","normalizedEntry","entry","type","traceFile","traceData","changedDependency","all","fileHashes","map","file","acquire","relativeTraceFile","relative","originalTraceFile","absoluteFile","dirname","startsWith","prevHash","curHash","release","error","isGlobalEntry","test","push","getPageFromPath"],"mappings":"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"}