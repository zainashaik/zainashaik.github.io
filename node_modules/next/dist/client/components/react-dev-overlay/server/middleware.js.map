{"version":3,"sources":["../../../../../src/client/components/react-dev-overlay/server/middleware.ts"],"sourcesContent":["import { constants as FS, promises as fs } from 'fs'\nimport path from 'path'\nimport url from 'url'\nimport { SourceMapConsumer } from 'next/dist/compiled/source-map08'\nimport type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\nimport { getSourceMapFromFile } from '../internal/helpers/get-source-map-from-file'\nimport { launchEditor } from '../internal/helpers/launchEditor'\nimport {\n  badRequest,\n  findSourcePackage,\n  getOriginalCodeFrame,\n  internalServerError,\n  json,\n  noContent,\n  type OriginalStackFrameResponse,\n} from './shared'\nimport { NEXT_PROJECT_ROOT } from '../../../../build/next-dir-paths'\nexport { getServerError } from '../internal/helpers/node-stack-frames'\nexport { parseStack } from '../internal/helpers/parse-stack'\nexport { getSourceMapFromFile }\n\nimport type { IncomingMessage, ServerResponse } from 'http'\nimport type webpack from 'webpack'\nimport type { RawSourceMap } from 'next/dist/compiled/source-map08'\nimport { formatFrameSourceFile } from '../internal/helpers/webpack-module-path'\n\ntype Source =\n  | {\n      type: 'file'\n      sourceMap: RawSourceMap\n      modulePath: string\n    }\n  | {\n      type: 'bundle'\n      sourceMap: RawSourceMap\n      compilation: webpack.Compilation\n      moduleId: string\n      modulePath: string\n    }\n\nfunction getModuleById(\n  id: string | undefined,\n  compilation: webpack.Compilation\n) {\n  const { chunkGraph, modules } = compilation\n\n  return [...modules].find((module) => chunkGraph.getModuleId(module) === id)\n}\n\nfunction findModuleNotFoundFromError(errorMessage: string | undefined) {\n  return errorMessage?.match(/'([^']+)' module/)?.[1]\n}\n\nfunction getSourcePath(source: string) {\n  return source.replace(/^(webpack:\\/\\/\\/|webpack:\\/\\/|webpack:\\/\\/_N_E\\/)/, '')\n}\n\nasync function findOriginalSourcePositionAndContent(\n  sourceMap: RawSourceMap,\n  position: { line: number; column: number | null }\n) {\n  const consumer = await new SourceMapConsumer(sourceMap)\n  try {\n    const sourcePosition = consumer.originalPositionFor({\n      line: position.line,\n      column: position.column ?? 0,\n    })\n\n    if (!sourcePosition.source) {\n      return null\n    }\n\n    const sourceContent: string | null =\n      consumer.sourceContentFor(\n        sourcePosition.source,\n        /* returnNullOnMissing */ true\n      ) ?? null\n\n    return {\n      sourcePosition,\n      sourceContent,\n    }\n  } finally {\n    consumer.destroy()\n  }\n}\n\nfunction createStackFrame(searchParams: URLSearchParams) {\n  return {\n    file: searchParams.get('file') as string,\n    methodName: searchParams.get('methodName') as string,\n    lineNumber: parseInt(searchParams.get('lineNumber') ?? '0', 10) || 0,\n    column: parseInt(searchParams.get('column') ?? '0', 10) || 0,\n    arguments: searchParams.getAll('arguments').filter(Boolean),\n  } satisfies StackFrame\n}\n\nfunction findOriginalSourcePositionAndContentFromCompilation(\n  moduleId: string | undefined,\n  importedModule: string,\n  compilation: webpack.Compilation\n) {\n  const module = getModuleById(moduleId, compilation)\n  return module?.buildInfo?.importLocByPath?.get(importedModule) ?? null\n}\n\nexport async function createOriginalStackFrame({\n  source,\n  rootDirectory,\n  frame,\n  errorMessage,\n}: {\n  source: Source\n  rootDirectory: string\n  frame: StackFrame\n  errorMessage?: string\n}): Promise<OriginalStackFrameResponse | null> {\n  const { lineNumber, column } = frame\n  const moduleNotFound = findModuleNotFoundFromError(errorMessage)\n  const result = await (async () => {\n    if (moduleNotFound) {\n      if (source.type === 'file') {\n        return undefined\n      }\n\n      return findOriginalSourcePositionAndContentFromCompilation(\n        source.moduleId,\n        moduleNotFound,\n        source.compilation\n      )\n    }\n    // This returns 1-based lines and 0-based columns\n    return await findOriginalSourcePositionAndContent(source.sourceMap, {\n      line: lineNumber ?? 1,\n      column,\n    })\n  })()\n\n  if (!result?.sourcePosition.source) {\n    return null\n  }\n\n  const { sourcePosition, sourceContent } = result\n\n  const filePath = path.resolve(\n    rootDirectory,\n    getSourcePath(\n      // When sourcePosition.source is the loader path the modulePath is generally better.\n      (sourcePosition.source.includes('|')\n        ? source.modulePath\n        : sourcePosition.source) || source.modulePath\n    )\n  )\n\n  const resolvedFilePath = sourceContent\n    ? path.relative(rootDirectory, filePath)\n    : sourcePosition.source\n\n  const traced = {\n    file: resolvedFilePath,\n    lineNumber: sourcePosition.line,\n    column: (sourcePosition.column ?? 0) + 1,\n    methodName:\n      sourcePosition.name ||\n      // default is not a valid identifier in JS so webpack uses a custom variable when it's an unnamed default export\n      // Resolve it back to `default` for the method name if the source position didn't have the method.\n      frame.methodName\n        ?.replace('__WEBPACK_DEFAULT_EXPORT__', 'default')\n        ?.replace('__webpack_exports__.', ''),\n    arguments: [],\n  } satisfies StackFrame\n\n  return {\n    originalStackFrame: traced,\n    originalCodeFrame: getOriginalCodeFrame(traced, sourceContent),\n    sourcePackage: findSourcePackage(traced),\n  }\n}\n\nexport async function getSourceMapFromCompilation(\n  id: string,\n  compilation: webpack.Compilation\n): Promise<RawSourceMap | undefined> {\n  try {\n    const module = getModuleById(id, compilation)\n\n    if (!module) {\n      return undefined\n    }\n\n    // @ts-expect-error The types for `CodeGenerationResults.get` require a\n    // runtime to be passed as second argument, but apparently it also works\n    // without it.\n    const codeGenerationResult = compilation.codeGenerationResults.get(module)\n    const source = codeGenerationResult?.sources.get('javascript')\n\n    return source?.map() ?? undefined\n  } catch (err) {\n    console.error(`Failed to lookup module by ID (\"${id}\"):`, err)\n    return undefined\n  }\n}\n\nexport async function getSource(\n  filename: string,\n  options: {\n    assetPrefix: string\n    distDirectory: string\n    getCompilations: () => webpack.Compilation[]\n  }\n): Promise<Source | undefined> {\n  const { assetPrefix, distDirectory, getCompilations } = options\n\n  // With Webpack, this branch can only be hit when manually changing from\n  // `eval-source-map` to `source-map` for testing purposes.\n  if (filename.startsWith(`${assetPrefix}/_next/static`)) {\n    filename = path.join(\n      distDirectory,\n      filename.replace(new RegExp(`^${assetPrefix}/_next/`), '')\n    )\n  }\n\n  if (path.isAbsolute(filename)) {\n    filename = url.pathToFileURL(filename).href\n  }\n\n  if (filename.startsWith('file:')) {\n    const sourceMap = await getSourceMapFromFile(filename)\n\n    return sourceMap\n      ? {\n          type: 'file',\n          sourceMap,\n          modulePath: filename.replace(/^file:\\/\\//, ''),\n        }\n      : undefined\n  }\n\n  // webpack-internal:///./src/hello.tsx => ./src/hello.tsx\n  // rsc://React/Server/webpack-internal:///(rsc)/./src/hello.tsx?42 => (rsc)/./src/hello.tsx\n  // webpack://_N_E/./src/hello.tsx => ./src/hello.tsx\n  const moduleId = filename\n    .replace(\n      /^(rsc:\\/\\/React\\/[^/]+\\/)?(webpack-internal:\\/\\/\\/|webpack:\\/\\/(_N_E\\/)?)/,\n      ''\n    )\n    .replace(/\\?\\d+$/, '')\n\n  // (rsc)/./src/hello.tsx => ./src/hello.tsx\n  const modulePath = moduleId.replace(/^(\\(.*\\)\\/?)/, '')\n\n  for (const compilation of getCompilations()) {\n    // TODO: `ignoreList`\n    const sourceMap = await getSourceMapFromCompilation(moduleId, compilation)\n\n    if (sourceMap) {\n      return { type: 'bundle', sourceMap, compilation, moduleId, modulePath }\n    }\n  }\n\n  return undefined\n}\n\nexport function getOverlayMiddleware(options: {\n  assetPrefix: string\n  distDirectory: string\n  rootDirectory: string\n  clientStats: () => webpack.Stats | null\n  serverStats: () => webpack.Stats | null\n  edgeServerStats: () => webpack.Stats | null\n}) {\n  const {\n    assetPrefix,\n    distDirectory,\n    rootDirectory,\n    clientStats,\n    serverStats,\n    edgeServerStats,\n  } = options\n\n  return async function (\n    req: IncomingMessage,\n    res: ServerResponse,\n    next: () => void\n  ): Promise<void> {\n    const { pathname, searchParams } = new URL(`http://n${req.url}`)\n\n    if (pathname === '/__nextjs_original-stack-frame') {\n      const isServer = searchParams.get('isServer') === 'true'\n      const isEdgeServer = searchParams.get('isEdgeServer') === 'true'\n      const isAppDirectory = searchParams.get('isAppDirectory') === 'true'\n      const frame = createStackFrame(searchParams)\n\n      let sourcePackage = findSourcePackage(frame)\n\n      if (\n        !(\n          /^(rsc:\\/\\/React\\/[^/]+\\/)?(webpack-internal:\\/\\/\\/|(file|webpack):\\/\\/)/.test(\n            frame.file\n          ) && frame.lineNumber\n        )\n      ) {\n        if (sourcePackage) return json(res, { sourcePackage })\n        return badRequest(res)\n      }\n\n      const formattedFilePath = formatFrameSourceFile(frame.file)\n      const filePath = path.join(rootDirectory, formattedFilePath)\n      const isNextjsSource = filePath.startsWith(NEXT_PROJECT_ROOT)\n\n      let source: Source | undefined\n\n      if (isNextjsSource) {\n        sourcePackage = 'next'\n        return json(res, { sourcePackage })\n      }\n\n      try {\n        source = await getSource(frame.file, {\n          assetPrefix,\n          distDirectory,\n          getCompilations: () => {\n            const compilations: webpack.Compilation[] = []\n\n            // Try Client Compilation first. In `pages` we leverage\n            // `isClientError` to check. In `app` it depends on if it's a server\n            // / client component and when the code throws. E.g. during HTML\n            // rendering it's the server/edge compilation.\n            if ((!isEdgeServer && !isServer) || isAppDirectory) {\n              const compilation = clientStats()?.compilation\n\n              if (compilation) {\n                compilations.push(compilation)\n              }\n            }\n\n            // Try Server Compilation. In `pages` this could be something\n            // imported in getServerSideProps/getStaticProps as the code for\n            // those is tree-shaken. In `app` this finds server components and\n            // code that was imported from a server component. It also covers\n            // when client component code throws during HTML rendering.\n            if (isServer || isAppDirectory) {\n              const compilation = serverStats()?.compilation\n\n              if (compilation) {\n                compilations.push(compilation)\n              }\n            }\n\n            // Try Edge Server Compilation. Both cases are the same as Server\n            // Compilation, main difference is that it covers `runtime: 'edge'`\n            // pages/app routes.\n            if (isEdgeServer || isAppDirectory) {\n              const compilation = edgeServerStats()?.compilation\n\n              if (compilation) {\n                compilations.push(compilation)\n              }\n            }\n\n            return compilations\n          },\n        })\n      } catch (err) {\n        console.error('Failed to get source map:', err)\n        return internalServerError(res)\n      }\n\n      if (!source) {\n        if (sourcePackage) return json(res, { sourcePackage })\n        return noContent(res)\n      }\n\n      try {\n        const originalStackFrameResponse = await createOriginalStackFrame({\n          frame,\n          source,\n          rootDirectory,\n        })\n\n        if (!originalStackFrameResponse) {\n          if (sourcePackage) return json(res, { sourcePackage })\n          return noContent(res)\n        }\n\n        return json(res, originalStackFrameResponse)\n      } catch (err) {\n        console.log('Failed to parse source map:', err)\n        return internalServerError(res)\n      }\n    } else if (pathname === '/__nextjs_launch-editor') {\n      const frame = createStackFrame(searchParams)\n\n      if (!frame.file) return badRequest(res)\n\n      // frame files may start with their webpack layer, like (middleware)/middleware.js\n      const filePath = path.resolve(\n        rootDirectory,\n        frame.file.replace(/^\\([^)]+\\)\\//, '')\n      )\n      const fileExists = await fs.access(filePath, FS.F_OK).then(\n        () => true,\n        () => false\n      )\n      if (!fileExists) return noContent(res)\n\n      try {\n        await launchEditor(filePath, frame.lineNumber, frame.column ?? 1)\n      } catch (err) {\n        console.log('Failed to launch editor:', err)\n        return internalServerError(res)\n      }\n\n      return noContent(res)\n    }\n\n    return next()\n  }\n}\n\nexport function getSourceMapMiddleware(options: {\n  assetPrefix: string\n  distDirectory: string\n  clientStats: () => webpack.Stats | null\n  serverStats: () => webpack.Stats | null\n  edgeServerStats: () => webpack.Stats | null\n}) {\n  const {\n    assetPrefix,\n    distDirectory,\n    clientStats,\n    serverStats,\n    edgeServerStats,\n  } = options\n\n  return async function (\n    req: IncomingMessage,\n    res: ServerResponse,\n    next: () => void\n  ): Promise<void> {\n    const { pathname, searchParams } = new URL(`http://n${req.url}`)\n\n    if (pathname !== '/__nextjs_source-map') {\n      return next()\n    }\n\n    const filename = searchParams.get('filename')\n\n    if (!filename) {\n      return badRequest(res)\n    }\n\n    let source: Source | undefined\n\n    try {\n      source = await getSource(filename, {\n        assetPrefix,\n        distDirectory,\n        getCompilations: () => {\n          const compilations: webpack.Compilation[] = []\n\n          for (const stats of [\n            clientStats(),\n            serverStats(),\n            edgeServerStats(),\n          ]) {\n            if (stats?.compilation) {\n              compilations.push(stats.compilation)\n            }\n          }\n\n          return compilations\n        },\n      })\n    } catch (error) {\n      console.error('Failed to get source map:', error)\n\n      return internalServerError(res)\n    }\n\n    if (!source) {\n      return noContent(res)\n    }\n\n    return json(res, source.sourceMap)\n  }\n}\n"],"names":["createOriginalStackFrame","getOverlayMiddleware","getServerError","getSource","getSourceMapFromCompilation","getSourceMapFromFile","getSourceMapMiddleware","parseStack","getModuleById","id","compilation","chunkGraph","modules","find","module","getModuleId","findModuleNotFoundFromError","errorMessage","match","getSourcePath","source","replace","findOriginalSourcePositionAndContent","sourceMap","position","consumer","SourceMapConsumer","sourcePosition","originalPositionFor","line","column","sourceContent","sourceContentFor","destroy","createStackFrame","searchParams","file","get","methodName","lineNumber","parseInt","arguments","getAll","filter","Boolean","findOriginalSourcePositionAndContentFromCompilation","moduleId","importedModule","buildInfo","importLocByPath","rootDirectory","frame","moduleNotFound","result","type","undefined","filePath","path","resolve","includes","modulePath","resolvedFilePath","relative","traced","name","originalStackFrame","originalCodeFrame","getOriginalCodeFrame","sourcePackage","findSourcePackage","codeGenerationResult","codeGenerationResults","sources","map","err","console","error","filename","options","assetPrefix","distDirectory","getCompilations","startsWith","join","RegExp","isAbsolute","url","pathToFileURL","href","clientStats","serverStats","edgeServerStats","req","res","next","pathname","URL","isServer","isEdgeServer","isAppDirectory","test","json","badRequest","formattedFilePath","formatFrameSourceFile","isNextjsSource","NEXT_PROJECT_ROOT","compilations","push","internalServerError","noContent","originalStackFrameResponse","log","fileExists","fs","access","FS","F_OK","then","launchEditor","stats"],"mappings":"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"}