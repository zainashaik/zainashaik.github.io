{"version":3,"sources":["../../../../../src/client/components/react-dev-overlay/server/middleware-turbopack.ts"],"sourcesContent":["import type { IncomingMessage, ServerResponse } from 'http'\nimport {\n  badRequest,\n  findSourcePackage,\n  getOriginalCodeFrame,\n  internalServerError,\n  json,\n  jsonString,\n  noContent,\n  type OriginalStackFrameResponse,\n} from './shared'\n\nimport fs, { constants as FS } from 'fs/promises'\nimport path from 'path'\nimport url from 'url'\nimport { launchEditor } from '../internal/helpers/launchEditor'\nimport type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\nimport type { Project, TurbopackStackFrame } from '../../../../build/swc/types'\nimport { getSourceMapFromFile } from '../internal/helpers/get-source-map-from-file'\nimport { findSourceMap } from 'node:module'\n\nconst currentSourcesByFile: Map<string, Promise<string | null>> = new Map()\nexport async function batchedTraceSource(\n  project: Project,\n  frame: TurbopackStackFrame\n): Promise<{ frame: StackFrame; source: string | null } | undefined> {\n  const file = frame.file ? decodeURIComponent(frame.file) : undefined\n  if (!file) return\n\n  const sourceFrame = await project.traceSource(frame)\n  if (!sourceFrame) return\n\n  let source = null\n  // Don't look up source for node_modules or internals. These can often be large bundled files.\n  if (\n    sourceFrame.file &&\n    !(sourceFrame.file.includes('node_modules') || sourceFrame.isInternal)\n  ) {\n    let sourcePromise = currentSourcesByFile.get(sourceFrame.file)\n    if (!sourcePromise) {\n      sourcePromise = project.getSourceForAsset(sourceFrame.file)\n      currentSourcesByFile.set(sourceFrame.file, sourcePromise)\n      setTimeout(() => {\n        // Cache file reads for 100ms, as frames will often reference the same\n        // files and can be large.\n        currentSourcesByFile.delete(sourceFrame.file!)\n      }, 100)\n    }\n\n    source = await sourcePromise\n  }\n\n  return {\n    frame: {\n      file: sourceFrame.file,\n      lineNumber: sourceFrame.line ?? 0,\n      column: sourceFrame.column ?? 0,\n      methodName: sourceFrame.methodName ?? frame.methodName ?? '<unknown>',\n      arguments: [],\n    },\n    source,\n  }\n}\n\nfunction createStackFrame(searchParams: URLSearchParams) {\n  const fileParam = searchParams.get('file')\n\n  if (!fileParam) {\n    return undefined\n  }\n\n  // rsc://React/Server/file://<filename>?42 => file://<filename>\n  const file = fileParam\n    .replace(/^rsc:\\/\\/React\\/[^/]+\\//, '')\n    .replace(/\\?\\d+$/, '')\n\n  return {\n    file,\n    methodName: searchParams.get('methodName') ?? '<unknown>',\n    line: parseInt(searchParams.get('lineNumber') ?? '0', 10) || 0,\n    column: parseInt(searchParams.get('column') ?? '0', 10) || 0,\n    isServer: searchParams.get('isServer') === 'true',\n  } satisfies TurbopackStackFrame\n}\n\nexport async function createOriginalStackFrame(\n  project: Project,\n  frame: TurbopackStackFrame\n): Promise<OriginalStackFrameResponse | null> {\n  const traced = await batchedTraceSource(project, frame)\n  if (!traced) {\n    const sourcePackage = findSourcePackage(frame)\n    if (sourcePackage) return { sourcePackage }\n    return null\n  }\n\n  return {\n    originalStackFrame: traced.frame,\n    originalCodeFrame: getOriginalCodeFrame(traced.frame, traced.source),\n    sourcePackage: findSourcePackage(traced.frame),\n  }\n}\n\nexport function getOverlayMiddleware(project: Project) {\n  return async function (\n    req: IncomingMessage,\n    res: ServerResponse,\n    next: () => void\n  ): Promise<void> {\n    const { pathname, searchParams } = new URL(req.url!, 'http://n')\n\n    if (pathname === '/__nextjs_original-stack-frame') {\n      const frame = createStackFrame(searchParams)\n\n      if (!frame) return badRequest(res)\n\n      let originalStackFrame: OriginalStackFrameResponse | null\n      try {\n        originalStackFrame = await createOriginalStackFrame(project, frame)\n      } catch (e: any) {\n        return internalServerError(res, e.message)\n      }\n\n      if (!originalStackFrame) {\n        res.statusCode = 404\n        res.end('Unable to resolve sourcemap')\n        return\n      }\n\n      return json(res, originalStackFrame)\n    } else if (pathname === '/__nextjs_launch-editor') {\n      const frame = createStackFrame(searchParams)\n\n      if (!frame) return badRequest(res)\n\n      const fileExists = await fs.access(frame.file, FS.F_OK).then(\n        () => true,\n        () => false\n      )\n      if (!fileExists) return noContent(res)\n\n      try {\n        launchEditor(frame.file, frame.line ?? 1, frame.column ?? 1)\n      } catch (err) {\n        console.log('Failed to launch editor:', err)\n        return internalServerError(res)\n      }\n\n      noContent(res)\n    }\n\n    return next()\n  }\n}\n\nexport function getSourceMapMiddleware(\n  project: Project,\n  options: { assetPrefix: string; distDir: string }\n) {\n  return async function (\n    req: IncomingMessage,\n    res: ServerResponse,\n    next: () => void\n  ): Promise<void> {\n    const { pathname, searchParams } = new URL(req.url!, 'http://n')\n\n    if (pathname !== '/__nextjs_source-map') {\n      return next()\n    }\n\n    let filename = searchParams.get('filename')\n\n    if (!filename) {\n      return badRequest(res)\n    }\n\n    if (\n      filename.startsWith('webpack://') ||\n      filename.startsWith('webpack-internal:///')\n    ) {\n      const sourceMap = findSourceMap(filename)\n\n      if (sourceMap) {\n        return json(res, sourceMap.payload)\n      }\n\n      return noContent(res)\n    }\n\n    try {\n      const { assetPrefix, distDir } = options\n\n      if (filename.startsWith(`${assetPrefix}/_next/static`)) {\n        filename = path.join(\n          distDir,\n          filename.replace(new RegExp(`^${assetPrefix}/_next/`), '')\n        )\n      }\n\n      // Turbopack chunk filenames might be URL-encoded.\n      filename = decodeURI(filename)\n\n      if (path.isAbsolute(filename)) {\n        filename = url.pathToFileURL(filename).href\n      }\n\n      const sourceMapString = await project.getSourceMap(filename)\n\n      if (sourceMapString) {\n        return jsonString(res, sourceMapString)\n      }\n\n      if (filename.startsWith('file:')) {\n        const sourceMap = await getSourceMapFromFile(filename)\n\n        if (sourceMap) {\n          return json(res, sourceMap)\n        }\n      }\n    } catch (error) {\n      console.error('Failed to get source map:', error)\n    }\n\n    noContent(res)\n  }\n}\n"],"names":["batchedTraceSource","createOriginalStackFrame","getOverlayMiddleware","getSourceMapMiddleware","currentSourcesByFile","Map","project","frame","file","decodeURIComponent","undefined","sourceFrame","traceSource","source","includes","isInternal","sourcePromise","get","getSourceForAsset","set","setTimeout","delete","lineNumber","line","column","methodName","arguments","createStackFrame","searchParams","fileParam","replace","parseInt","isServer","traced","sourcePackage","findSourcePackage","originalStackFrame","originalCodeFrame","getOriginalCodeFrame","req","res","next","pathname","URL","url","badRequest","e","internalServerError","message","statusCode","end","json","fileExists","fs","access","FS","F_OK","then","noContent","launchEditor","err","console","log","options","filename","startsWith","sourceMap","findSourceMap","payload","assetPrefix","distDir","path","join","RegExp","decodeURI","isAbsolute","pathToFileURL","href","sourceMapString","getSourceMap","jsonString","getSourceMapFromFile","error"],"mappings":"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"}